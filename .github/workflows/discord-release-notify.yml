name: Discord Release Notify

on:
  release:
    types: [published, prereleased]
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag override (optional)"
        required: false
        type: string
      title:
        description: "Release title override (optional)"
        required: false
        type: string
      url:
        description: "Release URL override (optional)"
        required: false
        type: string
      notes:
        description: "Release notes override (optional)"
        required: false
        type: string
      style:
        description: "Theme style (SIINDBAD or KAMUE)"
        required: false
        default: "SIINDBAD"
        type: choice
        options:
          - SIINDBAD
          - KAMUE
      prerelease:
        description: "Mark manual dispatch as prerelease"
        required: false
        default: false
        type: boolean

permissions:
  contents: read

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord release message
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_RELEASE_WEBHOOK }}
          EVENT_NAME: ${{ github.event_name }}
          RELEASE_TAG: ${{ github.event.release.tag_name }}
          RELEASE_NAME: ${{ github.event.release.name }}
          RELEASE_URL: ${{ github.event.release.html_url }}
          RELEASE_BODY: ${{ github.event.release.body }}
          RELEASE_IS_PRERELEASE: ${{ github.event.release.prerelease }}
          MANUAL_TAG: ${{ inputs.tag }}
          MANUAL_TITLE: ${{ inputs.title }}
          MANUAL_URL: ${{ inputs.url }}
          MANUAL_NOTES: ${{ inputs.notes }}
          MANUAL_STYLE: ${{ inputs.style }}
          MANUAL_PRERELEASE: ${{ inputs.prerelease }}
          REPO_NAME: ${{ github.repository }}
          DEFAULT_STYLE: ${{ vars.DISCORD_RELEASE_STYLE }}
          DISCORD_USERNAME: ${{ vars.DISCORD_RELEASE_USERNAME }}
          DISCORD_AVATAR_URL: ${{ vars.DISCORD_RELEASE_AVATAR_URL }}
          DISCORD_MENTION: ${{ vars.DISCORD_RELEASE_MENTION }}
          DISCORD_COLOR: ${{ vars.DISCORD_RELEASE_COLOR }}
        shell: bash
        run: |
          python - <<'PY'
          import json
          import os
          import sys
          import time
          import urllib.error
          import urllib.request

          webhook = (os.getenv("DISCORD_WEBHOOK_URL") or "").strip()
          if not webhook:
              print("DISCORD_RELEASE_WEBHOOK is not set. Skipping Discord notify.")
              sys.exit(0)

          event_name = (os.getenv("EVENT_NAME") or "").strip()

          def _pick(*values):
              for value in values:
                  text = (value or "").strip()
                  if text:
                      return text
              return ""

          tag = _pick(os.getenv("MANUAL_TAG"), os.getenv("RELEASE_TAG"))
          title = _pick(os.getenv("MANUAL_TITLE"), os.getenv("RELEASE_NAME"), f"Release {tag}" if tag else "")
          url = _pick(os.getenv("MANUAL_URL"), os.getenv("RELEASE_URL"))
          notes = _pick(os.getenv("MANUAL_NOTES"), os.getenv("RELEASE_BODY"))

          manual_pre = (os.getenv("MANUAL_PRERELEASE") or "").strip().lower() in {"1", "true", "yes", "on"}
          event_pre = (os.getenv("RELEASE_IS_PRERELEASE") or "").strip().lower() in {"1", "true", "yes", "on"}
          is_prerelease = manual_pre if event_name == "workflow_dispatch" else event_pre
          style = _pick(os.getenv("MANUAL_STYLE"), os.getenv("DEFAULT_STYLE"), "SIINDBAD").upper()
          if style not in {"SIINDBAD", "KAMUE"}:
              style = "SIINDBAD"

          mention = (os.getenv("DISCORD_MENTION") or "").strip()
          content = mention if mention else ""

          color_text = (os.getenv("DISCORD_COLOR") or "").strip()
          try:
              if color_text:
                  color = int(color_text)
              elif style == "KAMUE":
                  color = 12336895
              else:
                  # Darker cyan accent for SIINDBAD release embeds.
                  color = 16753920 if is_prerelease else 757408
          except Exception:
              color = 5814783

          repo = (os.getenv("REPO_NAME") or "").strip()
          releases_url = f"https://github.com/{repo}/releases" if repo else ""

          version_label = tag or title or "N/A"
          embed_title = f"SINS SAVE EDITOR {version_label}"
          notes_text = (notes or "").strip()
          if len(notes_text) > 3850:
              notes_text = notes_text[:3847] + "..."
          download_line = f"[Download Latest Release]({url or releases_url})" if (url or releases_url) else ""
          if notes_text:
              if download_line:
                  description = f"New Release!\n\n{download_line}\n\n{notes_text}"
              else:
                  description = f"New Release!\n\n{notes_text}"
          else:
              description = f"New Release!\n\n{download_line}" if download_line else "New Release!"

          embed = {
              "title": embed_title,
              "description": description,
              "color": color,
              "timestamp": time.strftime("%Y-%m-%dT%H:%M:%SZ", time.gmtime()),
          }
          if url:
              embed["url"] = url

          payload = {
              "content": content,
              "embeds": [embed],
              "allowed_mentions": {"parse": []},
          }

          username = (os.getenv("DISCORD_USERNAME") or "").strip()
          avatar = (os.getenv("DISCORD_AVATAR_URL") or "").strip()
          if username:
              payload["username"] = username
          if avatar:
              payload["avatar_url"] = avatar

          data = json.dumps(payload).encode("utf-8")
          for attempt in range(1, 6):
              req = urllib.request.Request(
                  webhook,
                  data=data,
                  headers={
                      "Content-Type": "application/json",
                      "Accept": "application/json",
                      "User-Agent": "HackHub-Release-Notifier/1.0 (+https://github.com/Siindbad/HackHub-Save-File-Editor)",
                  },
                  method="POST",
              )
              try:
                  with urllib.request.urlopen(req, timeout=30) as resp:
                      print(f"Discord notify sent (status={resp.status}).")
                      sys.exit(0)
              except urllib.error.HTTPError as exc:
                  raw = exc.read().decode("utf-8", "replace")
                  if exc.code == 429 and attempt < 5:
                      wait_s = 2.0
                      try:
                          body = json.loads(raw or "{}")
                          wait_s = float(body.get("retry_after", wait_s))
                          # Discord may return milliseconds in some contexts.
                          if wait_s > 30:
                              wait_s = wait_s / 1000.0
                      except Exception:
                          pass
                      wait_s = max(1.0, min(wait_s, 30.0))
                      print(f"Discord rate limit hit, retrying in {wait_s:.2f}s (attempt {attempt}/5).")
                      time.sleep(wait_s)
                      continue
                  print(f"Discord notify failed: HTTP {exc.code}: {raw}", file=sys.stderr)
                  sys.exit(1)
              except Exception as exc:
                  if attempt < 5:
                      time.sleep(2.0)
                      continue
                  print(f"Discord notify failed: {exc}", file=sys.stderr)
                  sys.exit(1)
          PY
