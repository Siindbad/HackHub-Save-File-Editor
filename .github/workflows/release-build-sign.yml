name: Release Build and Sigstore Sign

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag to publish (example: v1.3.5)"
        required: true
        type: string

permissions:
  contents: write
  id-token: write

jobs:
  build-sign-release:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Resolve tag
        id: vars
        shell: pwsh
        run: |
          $tag = "${{ github.event.inputs.tag }}"
          if ([string]::IsNullOrWhiteSpace($tag)) {
            $tag = "${{ github.ref_name }}"
          }
          if ([string]::IsNullOrWhiteSpace($tag)) {
            throw "Unable to resolve release tag."
          }
          if (-not $tag.StartsWith("v")) {
            throw "Tag must start with 'v' (received: $tag)."
          }
          "tag=$tag" >> $env:GITHUB_OUTPUT

      - name: Install build requirements
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install -r source/requirements-build.txt

      - name: Build with PyInstaller
        working-directory: source
        shell: pwsh
        run: |
          python -m PyInstaller --noconfirm --distpath ../dist --workpath ../build sins_editor.spec

      - name: Package fallback zip and metadata
        shell: pwsh
        run: |
          if (-not (Test-Path "dist/sins_editor.exe")) {
            throw "dist/sins_editor.exe not found after build."
          }
          if (-not (Test-Path "dist/sins_editor-onedir")) {
            throw "dist/sins_editor-onedir not found after build."
          }
          if (Test-Path "dist/sins_editor-onedir.zip") {
            Remove-Item "dist/sins_editor-onedir.zip" -Force
          }
          Compress-Archive -Path "dist/sins_editor-onedir" -DestinationPath "dist/sins_editor-onedir.zip" -CompressionLevel Optimal -Force

          $match = Select-String -Path "source/core/constants.py" -Pattern 'APP_VERSION\s*=\s*"([^"]+)"' | Select-Object -First 1
          $version = ""
          if ($match -and $match.Matches.Count -gt 0) {
            $version = $match.Matches[0].Groups[1].Value
          }
          if ([string]::IsNullOrWhiteSpace($version)) {
            throw "Failed to parse APP_VERSION from source/core/constants.py."
          }
          Set-Content -Path "dist/version.txt" -Value $version -Encoding ASCII

          $exeHash = (Get-FileHash -Algorithm SHA256 -Path "dist/sins_editor.exe").Hash.ToLowerInvariant()
          Set-Content -Path "dist/sins_editor.exe.sha256" -Value "$exeHash *sins_editor.exe" -Encoding ASCII

          $zipHash = (Get-FileHash -Algorithm SHA256 -Path "dist/sins_editor-onedir.zip").Hash.ToLowerInvariant()
          $versionHash = (Get-FileHash -Algorithm SHA256 -Path "dist/version.txt").Hash.ToLowerInvariant()
          $builtUtc = (Get-Date).ToUniversalTime().ToString("yyyy-MM-ddTHH:mm:ssZ")
          $tag = "${{ steps.vars.outputs.tag }}"
          $reportLines = @(
            "report_format: v1",
            "tag: $tag",
            "built_utc: $builtUtc",
            "",
            "[ Assets ]",
            "sins_editor.exe sha256: $exeHash",
            "sins_editor-onedir.zip sha256: $zipHash",
            "version.txt sha256: $versionHash"
          )
          Set-Content -Path "dist/security-report.txt" -Value ($reportLines -join "`r`n") -Encoding ASCII

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3

      - name: Sigstore keyless sign artifacts
        shell: pwsh
        run: |
          $artifacts = @(
            "dist/sins_editor.exe",
            "dist/sins_editor-onedir.zip",
            "dist/version.txt",
            "dist/sins_editor.exe.sha256",
            "dist/security-report.txt"
          )
          foreach ($path in $artifacts) {
            if (-not (Test-Path $path)) {
              throw "Missing artifact for signing: $path"
            }
            cosign sign-blob --yes `
              --output-signature "$path.sig" `
              --output-certificate "$path.cert" `
              "$path"
          }

      - name: Bundle Sigstore proofs
        shell: pwsh
        run: |
          $zipPath = "dist/sigstore-proofs.zip"
          if (Test-Path $zipPath) {
            Remove-Item $zipPath -Force
          }
          $proofFiles = Get-ChildItem "dist" -File | Where-Object { $_.Name -match "\.(sig|cert)$" } | Sort-Object Name
          if (-not $proofFiles -or $proofFiles.Count -eq 0) {
            throw "No Sigstore proof files found to bundle."
          }
          Compress-Archive -Path ($proofFiles | ForEach-Object { $_.FullName }) -DestinationPath $zipPath -CompressionLevel Optimal -Force

      - name: Build release page sections
        shell: pwsh
        run: |
          $body = @(
            "## Download",
            "- `sins_editor.exe` (main app)",
            "- `sins_editor-onedir.zip` (portable fallback)",
            "",
            "## Verify",
            "- `sins_editor.exe.sha256`",
            "- `sigstore-proofs.zip`",
            "",
            "## Release Metadata",
            "- `version.txt`",
            "- `security-report.txt`",
            "",
            "## Changelog Information",
            "Auto-generated changelog notes are appended below."
          )
          Set-Content -Path "dist/release-body.md" -Value ($body -join "`r`n") -Encoding UTF8

      - name: Publish GitHub release assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.vars.outputs.tag }}
          body_path: dist/release-body.md
          append_body: true
          generate_release_notes: true
          files: |
            dist/sins_editor.exe
            dist/sins_editor-onedir.zip
            dist/sins_editor.exe.sha256
            dist/version.txt
            dist/security-report.txt
            dist/sigstore-proofs.zip
