name: Release Build and Sigstore Sign

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag to publish (example: v1.3.5)"
        required: true
        type: string

permissions:
  contents: write
  id-token: write

jobs:
  build-sign-release:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Resolve tag
        id: vars
        shell: pwsh
        run: |
          $tag = "${{ github.event.inputs.tag }}"
          if ([string]::IsNullOrWhiteSpace($tag)) {
            $tag = "${{ github.ref_name }}"
          }
          if ([string]::IsNullOrWhiteSpace($tag)) {
            throw "Unable to resolve release tag."
          }
          if (-not $tag.StartsWith("v")) {
            throw "Tag must start with 'v' (received: $tag)."
          }
          "tag=$tag" >> $env:GITHUB_OUTPUT
          "version=$($tag.Substring(1))" >> $env:GITHUB_OUTPUT

      - name: Install build requirements
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install -r source/requirements-build.txt

      - name: Build with PyInstaller
        working-directory: source
        shell: pwsh
        run: |
          python -m PyInstaller --noconfirm --distpath ../dist --workpath ../build sins_editor.spec

      - name: Package fallback zip and metadata
        shell: pwsh
        run: |
          if (-not (Test-Path "dist/sins_editor.exe")) {
            throw "dist/sins_editor.exe not found after build."
          }
          if (-not (Test-Path "dist/sins_editor-onedir")) {
            throw "dist/sins_editor-onedir not found after build."
          }
          if (Test-Path "dist/sins_editor-onedir.zip") {
            Remove-Item "dist/sins_editor-onedir.zip" -Force
          }
          Compress-Archive -Path "dist/sins_editor-onedir" -DestinationPath "dist/sins_editor-onedir.zip" -CompressionLevel Optimal -Force

          $match = Select-String -Path "source/core/constants.py" -Pattern 'APP_VERSION\s*=\s*"([^"]+)"' | Select-Object -First 1
          $version = ""
          if ($match -and $match.Matches.Count -gt 0) {
            $version = $match.Matches[0].Groups[1].Value
          }
          if ([string]::IsNullOrWhiteSpace($version)) {
            throw "Failed to parse APP_VERSION from source/core/constants.py."
          }
          Set-Content -Path "dist/version.txt" -Value $version -Encoding ASCII

          $exeHash = (Get-FileHash -Algorithm SHA256 -Path "dist/sins_editor.exe").Hash.ToLowerInvariant()
          Set-Content -Path "dist/sins_editor.exe.sha256" -Value "$exeHash *sins_editor.exe" -Encoding ASCII

          $zipHash = (Get-FileHash -Algorithm SHA256 -Path "dist/sins_editor-onedir.zip").Hash.ToLowerInvariant()
          $versionHash = (Get-FileHash -Algorithm SHA256 -Path "dist/version.txt").Hash.ToLowerInvariant()
          $builtUtc = (Get-Date).ToUniversalTime().ToString("yyyy-MM-ddTHH:mm:ssZ")
          $tag = "${{ steps.vars.outputs.tag }}"
          $reportLines = @(
            "report_format: v1",
            "tag: $tag",
            "built_utc: $builtUtc",
            "",
            "[ Assets ]",
            "sins_editor.exe sha256: $exeHash",
            "sins_editor-onedir.zip sha256: $zipHash",
            "version.txt sha256: $versionHash"
          )
          Set-Content -Path "dist/security-report.txt" -Value ($reportLines -join "`r`n") -Encoding ASCII

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3

      - name: Sigstore keyless sign artifacts
        shell: pwsh
        run: |
          $artifacts = @(
            "dist/sins_editor.exe",
            "dist/sins_editor-onedir.zip",
            "dist/version.txt",
            "dist/sins_editor.exe.sha256",
            "dist/security-report.txt"
          )
          foreach ($path in $artifacts) {
            if (-not (Test-Path $path)) {
              throw "Missing artifact for signing: $path"
            }
            cosign sign-blob --yes `
              --output-signature "$path.sig" `
              --output-certificate "$path.cert" `
              "$path"
          }

      - name: Bundle Sigstore proofs
        shell: pwsh
        run: |
          $zipPath = "dist/sigstore-proofs.zip"
          if (Test-Path $zipPath) {
            Remove-Item $zipPath -Force
          }
          $proofFiles = Get-ChildItem "dist" -File | Where-Object { $_.Name -match "\.(sig|cert)$" } | Sort-Object Name
          if (-not $proofFiles -or $proofFiles.Count -eq 0) {
            throw "No Sigstore proof files found to bundle."
          }
          Compress-Archive -Path ($proofFiles | ForEach-Object { $_.FullName }) -DestinationPath $zipPath -CompressionLevel Optimal -Force

      - name: Build release page sections
        shell: pwsh
        run: |
          $version = "${{ steps.vars.outputs.version }}"
          $changelogPath = "source/assets/Readme.txt"
          $changelogLines = @()
          if (Test-Path $changelogPath) {
            $lines = Get-Content -Path $changelogPath
            $escapedVersion = [Regex]::Escape($version)
            $versionPattern = "^\[\s*Version\s+$escapedVersion\s*\]$"
            $startIndex = -1
            for ($i = 0; $i -lt $lines.Count; $i++) {
              if ($lines[$i].Trim() -match $versionPattern) {
                $startIndex = $i + 1
                break
              }
            }
            if ($startIndex -ge 0) {
              for ($j = $startIndex; $j -lt $lines.Count; $j++) {
                $current = $lines[$j].Trim()
                if ($current -match "^\[.*\]$") {
                  break
                }
                if ($current -match "^- ") {
                  $changelogLines += $current
                }
              }
            }
          }
          if (-not $changelogLines -or $changelogLines.Count -eq 0) {
            $changelogLines = @("- No changelog notes provided.")
          }

          $body = @(
            '## Changelog'
          ) + $changelogLines + @(
            '',
            '## Download',
            '- `sins_editor.exe` (main app)',
            '- `sins_editor-onedir.zip` (portable fallback)',
            '',
            '## Verify',
            '- `sins_editor.exe.sha256`',
            '- `sigstore-proofs.zip`',
            '',
            '## Release Metadata',
            '- `version.txt`',
            '- `security-report.txt`',
            '',
            '## Changelog Information',
            'Auto-generated changelog notes are appended below.'
          )
          Set-Content -Path "dist/release-body.md" -Value ($body -join "`r`n") -Encoding UTF8

      - name: Sync public README changelog row
        shell: pwsh
        run: |
          python - <<'PY'
          from pathlib import Path
          import os
          import re
          import sys

          version = os.environ.get("APP_VERSION", "").strip()
          if not version:
              print("APP_VERSION env is required.", file=sys.stderr)
              sys.exit(1)

          readme_txt = Path("source/assets/Readme.txt")
          public_readme = Path("README.md")
          if not readme_txt.exists() or not public_readme.exists():
              print("Required files missing for README changelog sync.", file=sys.stderr)
              sys.exit(1)

          src_lines = readme_txt.read_text(encoding="utf-8", errors="replace").splitlines()
          target_header = f"[ Version {version} ]".lower()
          start = -1
          for i, line in enumerate(src_lines):
              if line.strip().lower() == target_header:
                  start = i + 1
                  break

          bullets = []
          if start >= 0:
              for line in src_lines[start:]:
                  t = line.strip()
                  if re.match(r"^\[.*\]$", t):
                      break
                  if t.startswith("- "):
                      bullets.append(t)

          if not bullets:
              bullets = ["- No changelog notes provided."]

          row = f"| **[ Version {version} ]**<br>" + "<br>".join(bullets) + " |"

          readme_lines = public_readme.read_text(encoding="utf-8", errors="replace").splitlines()
          change_logs_idx = -1
          for i, line in enumerate(readme_lines):
              if 'alt="CHANGE LOGS"' in line:
                  change_logs_idx = i
                  break

          if change_logs_idx < 0:
              print("CHANGE LOGS section not found in README.md", file=sys.stderr)
              sys.exit(1)

          replace_idx = -1
          for i in range(change_logs_idx + 1, min(change_logs_idx + 12, len(readme_lines))):
              if readme_lines[i].startswith("| **[ Version "):
                  replace_idx = i
                  break

          if replace_idx < 0:
              print("Version row not found near CHANGE LOGS section in README.md", file=sys.stderr)
              sys.exit(1)

          readme_lines[replace_idx] = row
          public_readme.write_text("\n".join(readme_lines) + "\n", encoding="utf-8")
          print(f"Synced README.md CHANGE LOGS row to Version {version}")
          PY
        env:
          APP_VERSION: ${{ steps.vars.outputs.version }}

      - name: Commit README changelog sync
        shell: pwsh
        run: |
          if ((git status --porcelain README.md).Length -eq 0) {
            Write-Host "README.md changelog already up to date."
            exit 0
          }
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "Sync public README changelog for v${{ steps.vars.outputs.version }}"
          git push origin HEAD:main

      - name: Publish GitHub release assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.vars.outputs.tag }}
          name: Sins Editor ${{ steps.vars.outputs.version }} x64
          body_path: dist/release-body.md
          append_body: false
          generate_release_notes: false
          files: |
            dist/sins_editor.exe
            dist/sins_editor-onedir.zip
            dist/sins_editor.exe.sha256
            dist/version.txt
            dist/security-report.txt
            dist/sigstore-proofs.zip
